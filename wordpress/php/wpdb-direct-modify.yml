rules:
  - id: wpdb-direct-modify
    languages:
      - php
    severity: WARNING
    mode: taint
    message: |
      Directly modifying core WordPress tables (comments, links, posts, terms,
      term_relationships, users, blogs, blog_versions, registration_log, signups, site)
      using $wpdb bypasses the built-in WordPress APIs.
      This can lead to data corruption, privilege escalation, or other vulnerabilities,
      even if insecure deserialization is not involved.
      Always use the official WordPress API functions instead of raw queries.
    pattern-sources:
      - pattern-either:
        - pattern: $wpdb->comments
        - pattern: $wpdb->links
        - pattern: $wpdb->posts
        - pattern: $wpdb->terms
        - pattern: $wpdb->term_relationships
        - pattern: $wpdb->users
        - pattern: $wpdb->blogs
        - pattern: $wpdb->blog_versions
        - pattern: $wpdb->registration_log
        - pattern: $wpdb->signups
        - pattern: $wpdb->site
      - patterns:
        - pattern: '"$STRING"'
        - metavariable-regex:
            metavariable: $STRING
            regex: ".*(comments|links|posts|terms|term_relationships|users|blogs|blog_versions|registration_log|signups|site).*"
    pattern-sinks:
      - pattern-either:
          - pattern: $wpdb->insert($TAB, ...)
          - pattern: $wpdb->update($TAB, ...)
      - pattern-either:
          - patterns:
              - pattern: |
                  sprintf($SQLSTR, ...)
              - metavariable-regex:
                  metavariable: $SQLSTR
                  regex: (?is).*\b(insert|update)\b.*
          - patterns:
              - pattern: |
                  $wpdb->prepare($SQLSTR, ...)
              - metavariable-regex:
                  metavariable: $SQLSTR
                  regex: (?is).*\b(insert|update)\b.*
          - patterns:
              - pattern: |
                  "...$EXPR..."
              - metavariable-regex:
                  metavariable: $EXPR
                  regex: (?is).*\b(insert|update)\b.*
          - patterns:
              - pattern: |
                  "$SQLSTR".$EXPR
              - metavariable-regex:
                  metavariable: $SQLSTR
                  regex: (?is).*\b(insert|update)\b.*

